@model Popup
@{
    ViewData["Title"] = "Campaign Designer";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .designer-container { display: flex; height: 100vh; }
        .top-navbar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
        .navbar-left, .navbar-center, .navbar-right { display: flex; align-items: center; gap: 12px; }
        .brand-logo { font-size: 20px; font-weight: 700; color: #2563eb; text-decoration: none; }
        .campaign-name { font-size: 15px; font-weight: 600; color: #1f2937; }
        .nav-tabs-custom { display: flex; gap: 4px; background: #f3f4f6; padding: 4px; border-radius: 6px; }
        .nav-tab { padding: 6px 16px; border-radius: 4px; border: none; background: transparent; color: #6b7280; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .nav-tab.active { background: white; color: #2563eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .device-toggle { display: flex; gap: 4px; background: #f3f4f6; padding: 4px; border-radius: 6px; }
        .device-btn { padding: 6px 12px; border: none; background: transparent; color: #6b7280; border-radius: 4px; cursor: pointer; }
        .device-btn.active { background: white; color: #2563eb; }
        .btn-primary-custom { background: #2563eb; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-secondary-custom { background: white; color: #374151; border: 1px solid #d1d5db; padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; }
        .left-sidebar { width: 280px; background: white; border-right: 1px solid #e5e7eb; margin-top: 60px; overflow-y: auto; display: none; }
        .left-sidebar.active { display: block; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .sidebar-title { font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 8px; }
        .search-box { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .blocks-section { padding: 16px; }
        .section-label { font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .block-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 24px; }
        .block-item { aspect-ratio: 1; border: 1px solid #e5e7eb; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: grab; transition: all 0.2s; padding: 12px; text-align: center; }
        .block-item:hover { border-color: #2563eb; background: #eff6ff; }
        .block-icon { font-size: 24px; color: #6b7280; margin-bottom: 6px; }
        .block-name { font-size: 12px; font-weight: 500; color: #374151; }
        .canvas-area { flex: 1; background: #f9fafb; margin-top: 60px; overflow: auto; display: flex; align-items: center; justify-content: center; padding: 40px; }
        .popup-canvas { background: white; width: 600px; min-height: 400px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); position: relative; }
        .popup-canvas.mobile-view { width: 375px; }
        .canvas-dropzone { padding: 40px; min-height: 400px; border: 2px dashed transparent; }
        .canvas-dropzone.drag-over { border-color: #2563eb; background: #eff6ff; }
        .right-sidebar { width: 320px; background: white; border-left: 1px solid #e5e7eb; margin-top: 60px; overflow-y: auto; }
        .properties-section, .rules-section, .integrations-section, .analytics-section { padding: 20px; display: none; }
        .properties-section.active, .rules-section.active, .integrations-section.active, .analytics-section.active { display: block; }
        .property-group { margin-bottom: 20px; }
        .property-label { font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; display: block; }
        .property-input, .property-select, .property-textarea { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .property-textarea { resize: vertical; }
        .color-picker-row { display: flex; gap: 8px; align-items: center; }
        .color-preview { width: 40px; height: 40px; border-radius: 6px; border: 1px solid #d1d5db; cursor: pointer; }
        .component-wrapper { position: relative; cursor: pointer; transition: all 0.2s; }
        .component-wrapper:hover { outline: 2px solid #93c5fd; }
        .component-wrapper.selected { outline: 2px solid #2563eb; }
        .component-controls { position: absolute; top: -32px; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 4px; display: none; gap: 4px; }
        .component-wrapper.selected .component-controls { display: flex; }
        .control-btn { width: 24px; height: 24px; border: none; background: transparent; cursor: pointer; border-radius: 4px; color: #6b7280; }
        .control-btn:hover { background: #f3f4f6; color: #2563eb; }
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .empty-state i { font-size: 48px; margin-bottom: 16px; display: block; }
        .form-check { margin-bottom: 12px; }
        .rule-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .rule-card h5 { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
        .stat-card { background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .stat-value { font-size: 24px; font-weight: 700; color: #111827; }
        .stat-label { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .btn-add { background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; margin-top: 12px; }
        .integration-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
        .integration-icon { width: 48px; height: 48px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .integration-info { flex: 1; }
        .integration-name { font-weight: 600; margin-bottom: 4px; }
        .integration-status { font-size: 12px; color: #6b7280; }
        .btn-configure { background: #2563eb; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="top-navbar">
        <div class="navbar-left">
            <a href="/Popup/Index" class="brand-logo">PopupManager</a>
            <div class="campaign-name">@Model.Name</div>
        </div>
        <div class="navbar-center">
            <div class="nav-tabs-custom">
                <button class="nav-tab active" data-tab="design">Design</button>
                <button class="nav-tab" data-tab="display-rules">Display Rules</button>
                <button class="nav-tab" data-tab="integrations">Integrations</button>
                <button class="nav-tab" data-tab="analytics">Analytics</button>
            </div>
        </div>
        <div class="navbar-right">
            <div class="device-toggle">
                <button class="device-btn active" data-device="desktop"><i class="bi bi-display"></i></button>
                <button class="device-btn" data-device="mobile"><i class="bi bi-phone"></i></button>
            </div>
            <button class="btn-secondary-custom" id="previewBtn"><i class="bi bi-eye"></i> Preview</button>
            <button class="btn-primary-custom" id="saveBtn"><i class="bi bi-check2"></i> Save</button>
        </div>
    </div>
    <div class="designer-container">
        <div class="left-sidebar active" id="designSidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">Blocks</h3>
                <input type="text" class="search-box" placeholder="Search blocks..." id="blockSearch">
            </div>
            <div class="blocks-section">
                <div class="section-label">Standard</div>
                <div class="block-list">
                    <div class="block-item" draggable="true" data-block-type="text"><div class="block-icon"><i class="bi bi-fonts"></i></div><div class="block-name">Text</div></div>
                    <div class="block-item" draggable="true" data-block-type="button"><div class="block-icon"><i class="bi bi-hand-index"></i></div><div class="block-name">Button</div></div>
                    <div class="block-item" draggable="true" data-block-type="image"><div class="block-icon"><i class="bi bi-image"></i></div><div class="block-name">Image</div></div>
                    <div class="block-item" draggable="true" data-block-type="fields"><div class="block-icon"><i class="bi bi-list-task"></i></div><div class="block-name">Input Field</div></div>
                    <div class="block-item" draggable="true" data-block-type="columns"><div class="block-icon"><i class="bi bi-layout-three-columns"></i></div><div class="block-name">Columns</div></div>
                    <div class="block-item" draggable="true" data-block-type="divider"><div class="block-icon"><i class="bi bi-dash-lg"></i></div><div class="block-name">Divider</div></div>
                    <div class="block-item" draggable="true" data-block-type="spacer"><div class="block-icon"><i class="bi bi-distribute-vertical"></i></div><div class="block-name">Spacer</div></div>
                    <div class="block-item" draggable="true" data-block-type="video"><div class="block-icon"><i class="bi bi-play-circle"></i></div><div class="block-name">Video</div></div>
                </div>
                <div class="section-label">Smart Blocks</div>
                <div class="block-list">
                    <div class="block-item" draggable="true" data-block-type="countdown"><div class="block-icon"><i class="bi bi-clock-history"></i></div><div class="block-name">Countdown</div></div>
                    <div class="block-item" draggable="true" data-block-type="social"><div class="block-icon"><i class="bi bi-share"></i></div><div class="block-name">Social</div></div>
                    <div class="block-item" draggable="true" data-block-type="coupon"><div class="block-icon"><i class="bi bi-tag"></i></div><div class="block-name">Coupon</div></div>
                    <div class="block-item" draggable="true" data-block-type="html"><div class="block-icon"><i class="bi bi-code-square"></i></div><div class="block-name">HTML</div></div>
                </div>
            </div>
        </div>
        <div class="canvas-area">
            <div class="popup-canvas" id="popupCanvas">
                <div class="canvas-dropzone" id="dropzone">
                    <div class="empty-state"><i class="bi bi-mouse"></i><p>Drag and drop blocks here to start building</p></div>
                </div>
            </div>
        </div>
        <div class="right-sidebar">
            <div class="properties-section active" id="propertiesPanel">
                <div class="empty-state" style="padding-top: 100px;"><i class="bi bi-sliders"></i><p>Select a block to edit properties</p></div>
            </div>
            <div class="rules-section" id="rulesPanel">
                <h4 style="margin-bottom: 20px; font-size: 16px; font-weight: 700;">Display Rules</h4>
                <div class="rule-card">
                    <h5>Trigger</h5>
                    <div class="property-group">
                        <label class="property-label">When to show</label>
                        <select class="property-select" id="triggerSelect">
                            <option value="OnPageLoad">On Page Load</option>
                            <option value="OnExitIntent">Exit Intent</option>
                            <option value="OnScroll">On Scroll</option>
                            <option value="OnTimeDelay">Time Delay</option>
                            <option value="OnClick">On Click</option>
                        </select>
                    </div>
                    <div class="property-group" id="delayGroup" style="display: none;">
                        <label class="property-label">Delay (seconds)</label>
                        <input type="number" class="property-input" id="delayInput" value="0" min="0">
                    </div>
                </div>
                <div class="rule-card">
                    <h5>Frequency</h5>
                    <div class="property-group">
                        <label class="property-label">How often to show</label>
                        <select class="property-select" id="frequencySelect">
                            <option value="EveryVisit">Every Visit</option>
                            <option value="OncePerSession">Once Per Session</option>
                            <option value="OncePerDay">Once Per Day</option>
                            <option value="OncePerWeek">Once Per Week</option>
                            <option value="OnceEver">Once Ever</option>
                        </select>
                    </div>
                </div>
                <div class="rule-card">
                    <h5>Device Targeting</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showMobile">
                        <label class="form-check-label" for="showMobile">Show on Mobile</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showDesktop">
                        <label class="form-check-label" for="showDesktop">Show on Desktop</label>
                    </div>
                </div>
                <div class="rule-card">
                    <h5>URL Targeting</h5>
                    <div class="property-group">
                        <label class="property-label">Show on URLs (one per line)</label>
                        <textarea class="property-textarea" id="urlTargeting" rows="4" placeholder="https://example.com/page1&#10;https://example.com/page2"></textarea>
                    </div>
                </div>
            </div>
            <div class="integrations-section" id="integrationsPanel">
                <h4 style="margin-bottom: 20px; font-size: 16px; font-weight: 700;">Integrations</h4>
                <div class="integration-card">
                    <div class="integration-icon"><i class="bi bi-envelope-fill"></i></div>
                    <div class="integration-info">
                        <div class="integration-name">Email Service</div>
                        <div class="integration-status">Connect to send captured emails</div>
                    </div>
                    <button class="btn-configure">Configure</button>
                </div>
                <div class="integration-card">
                    <div class="integration-icon"><i class="bi bi-lightning-fill"></i></div>
                    <div class="integration-info">
                        <div class="integration-name">Zapier</div>
                        <div class="integration-status">Automate workflows</div>
                    </div>
                    <button class="btn-configure">Configure</button>
                </div>
                <div class="integration-card">
                    <div class="integration-icon"><i class="bi bi-webhook"></i></div>
                    <div class="integration-info">
                        <div class="integration-name">Webhook</div>
                        <div class="integration-status">Send data to custom endpoint</div>
                    </div>
                    <button class="btn-configure">Configure</button>
                </div>
                <div class="property-group">
                    <label class="property-label">Webhook URL</label>
                    <input type="url" class="property-input" id="webhookUrl" placeholder="https://your-webhook-url.com/endpoint">
                </div>
                <button class="btn-add"><i class="bi bi-plus-circle"></i> Add Integration</button>
            </div>
            <div class="analytics-section" id="analyticsPanel">
                <h4 style="margin-bottom: 20px; font-size: 16px; font-weight: 700;">Analytics Overview</h4>
                <div class="stat-card">
                    <div class="stat-value">@Model.Views.ToString("N0")</div>
                    <div class="stat-label">Total Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">@Model.Clicks.ToString("N0")</div>
                    <div class="stat-label">Total Clicks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">@Model.Conversions.ToString("N0")</div>
                    <div class="stat-label">Conversions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">@(Model.Views > 0 ? ((double)Model.Clicks / Model.Views * 100).ToString("F1") : "0.0")%</div>
                    <div class="stat-label">Click Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">@(Model.Clicks > 0 ? ((double)Model.Conversions / Model.Clicks * 100).ToString("F1") : "0.0")%</div>
                    <div class="stat-label">Conversion Rate</div>
                </div>
                <a href="/Popup/Analytics/@Model.Id" class="btn-primary-custom" style="display: inline-block; margin-top: 12px; text-decoration: none;">View Detailed Analytics</a>
            </div>
        </div>
    </div>
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="background: #f3f4f6; padding: 40px;">
                    <div id="previewContent" style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const popupId = @Model.Id;
        let selectedComponent = null;
        let componentCounter = 0;

        window.addEventListener('DOMContentLoaded', function() {
            // Load existing values
            const trigger = '@Model.Trigger';
            const frequency = '@Model.Frequency';
            const delayMs = @Model.DelayMs;
            const showMobile = @Model.ShowOnMobile.ToString().ToLower();
            const showDesktop = @Model.ShowOnDesktop.ToString().ToLower();
            
            if (document.getElementById('triggerSelect')) {
                document.getElementById('triggerSelect').value = trigger;
                document.getElementById('delayGroup').style.display = trigger === 'OnTimeDelay' ? 'block' : 'none';
            }
            if (document.getElementById('frequencySelect')) document.getElementById('frequencySelect').value = frequency;
            if (document.getElementById('delayInput')) document.getElementById('delayInput').value = delayMs / 1000;
            if (document.getElementById('showMobile')) document.getElementById('showMobile').checked = showMobile === 'true';
            if (document.getElementById('showDesktop')) document.getElementById('showDesktop').checked = showDesktop === 'true';
            
            // Load existing content
            try {
                const contentStr = @Html.Raw(Json.Serialize(Model.Content ?? "{}"));
                console.log('Loading content:', contentStr);
                
                if (contentStr && contentStr !== '{}' && contentStr !== '') {
                    const parsed = typeof contentStr === 'string' ? JSON.parse(contentStr) : contentStr;
                    console.log('Parsed content:', parsed);
                    
                    if (parsed.html) {
                        document.getElementById('dropzone').innerHTML = parsed.html;
                        const emptyState = document.querySelector('.empty-state');
                        if (emptyState) emptyState.remove();
                        attachEventListeners();
                    } else if (Array.isArray(parsed)) {
                        // Handle block-based content
                        console.log('Loading block-based content');
                        const dropzone = document.getElementById('dropzone');
                        dropzone.innerHTML = '';
                        const emptyState = dropzone.querySelector('.empty-state');
                        if (emptyState) emptyState.remove();
                    }
                }
            } catch (e) {
                console.error('Error parsing content:', e);
            }
        });

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const tabName = this.dataset.tab;
                document.querySelectorAll('.properties-section, .rules-section, .integrations-section, .analytics-section').forEach(s => s.classList.remove('active'));
                if (tabName === 'design') {
                    document.getElementById('propertiesPanel').classList.add('active');
                    document.getElementById('designSidebar').classList.add('active');
                } else {
                    document.getElementById('designSidebar').classList.remove('active');
                    if (tabName === 'display-rules') document.getElementById('rulesPanel').classList.add('active');
                    else if (tabName === 'integrations') document.getElementById('integrationsPanel').classList.add('active');
                    else if (tabName === 'analytics') document.getElementById('analyticsPanel').classList.add('active');
                }
            });
        });

        document.querySelectorAll('.device-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('popupCanvas').classList.toggle('mobile-view', this.dataset.device === 'mobile');
            });
        });

        const dropzone = document.getElementById('dropzone');
        document.querySelectorAll('.block-item').forEach(block => {
            block.addEventListener('dragstart', e => e.dataTransfer.setData('blockType', block.dataset.blockType));
        });
        dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            addComponent(e.dataTransfer.getData('blockType'));
            const emptyState = dropzone.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
        });

        function addComponent(type) {
            componentCounter++;
            const wrapper = document.createElement('div');
            wrapper.className = 'component-wrapper';
            wrapper.dataset.componentId = componentCounter;
            wrapper.dataset.componentType = type;
            let content = '';
            switch(type) {
                case 'text': content = '<p contenteditable="true" style="margin: 16px 0; font-size: 16px; color: #374151;">Click to edit text</p>'; break;
                case 'button': content = '<div style="text-align: center; margin: 16px 0;"><button style="background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">Click Me</button></div>'; break;
                case 'image': content = '<div style="text-align: center; margin: 16px 0;"><img src="https://via.placeholder.com/400x200" style="max-width: 100%; border-radius: 8px;"></div>'; break;
                case 'fields': content = '<div style="margin: 16px 0;"><input type="email" placeholder="Enter your email" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;"></div>'; break;
                case 'divider': content = '<hr style="margin: 24px 0; border: 0; border-top: 1px solid #e5e7eb;">'; break;
                case 'spacer': content = '<div style="height: 32px;"></div>'; break;
                case 'video': content = '<div style="margin: 16px 0;"><div style="position: relative; padding-bottom: 56.25%; height: 0;"><iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" allowfullscreen></iframe></div></div>'; break;
                case 'countdown': content = '<div style="text-align: center; margin: 16px 0; font-size: 32px; font-weight: 700; color: #2563eb;">00:59:59</div>'; break;
                case 'columns': content = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0;"><div style="padding: 20px; background: #f3f4f6; border-radius: 8px;">Column 1</div><div style="padding: 20px; background: #f3f4f6; border-radius: 8px;">Column 2</div></div>'; break;
                default: content = `<div style="padding: 16px; background: #f3f4f6; border-radius: 8px; margin: 16px 0; text-align: center;">${type} block</div>`;
            }
            wrapper.innerHTML = `<div class="component-controls"><button class="control-btn" onclick="moveUp(${componentCounter})"><i class="bi bi-arrow-up"></i></button><button class="control-btn" onclick="moveDown(${componentCounter})"><i class="bi bi-arrow-down"></i></button><button class="control-btn" onclick="deleteComponent(${componentCounter})"><i class="bi bi-trash"></i></button></div>${content}`;
            dropzone.appendChild(wrapper);
            wrapper.addEventListener('click', function(e) { e.stopPropagation(); selectComponent(this); });
        }

        function attachEventListeners() {
            document.querySelectorAll('.component-wrapper').forEach((wrapper, index) => {
                if (!wrapper.dataset.componentId) wrapper.dataset.componentId = ++componentCounter;
                wrapper.addEventListener('click', function(e) { e.stopPropagation(); selectComponent(this); });
            });
        }

        function selectComponent(wrapper) {
            if (selectedComponent) selectedComponent.classList.remove('selected');
            selectedComponent = wrapper;
            wrapper.classList.add('selected');
            showProperties(wrapper.dataset.componentType);
        }

        function showProperties(type) {
            const panel = document.getElementById('propertiesPanel');
            let html = `<h4 style="margin-bottom: 20px; font-size: 16px; font-weight: 700;">${type.charAt(0).toUpperCase() + type.slice(1)} Properties</h4>`;
            switch(type) {
                case 'text':
                    html += '<div class="property-group"><label class="property-label">Font Size (px)</label><input type="number" class="property-input" id="fontSize" value="16" onchange="updateStyle(\'fontSize\', this.value + \'px\')"></div><div class="property-group"><label class="property-label">Text Color</label><div class="color-picker-row"><input type="color" class="color-preview" value="#374151" onchange="updateStyle(\'color\', this.value)"></div></div><div class="property-group"><label class="property-label">Alignment</label><select class="property-select" onchange="updateStyle(\'textAlign\', this.value)"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select></div>';
                    break;
                case 'button':
                    html += '<div class="property-group"><label class="property-label">Button Text</label><input type="text" class="property-input" value="Click Me" onchange="updateButtonText(this.value)"></div><div class="property-group"><label class="property-label">Background Color</label><div class="color-picker-row"><input type="color" class="color-preview" value="#2563eb" onchange="updateButtonStyle(\'background\', this.value)"></div></div><div class="property-group"><label class="property-label">Link URL</label><input type="url" class="property-input" placeholder="https://"></div>';
                    break;
                case 'image':
                    html += '<div class="property-group"><label class="property-label">Image URL</label><input type="url" class="property-input" value="https://via.placeholder.com/400x200" onchange="updateImage(this.value)"></div>';
                    break;
            }
            panel.innerHTML = html;
        }

        function updateStyle(property, value) {
            if (!selectedComponent) return;
            const elem = selectedComponent.querySelector('p');
            if (elem) elem.style[property] = value;
        }

        function updateButtonStyle(property, value) {
            if (!selectedComponent) return;
            const btn = selectedComponent.querySelector('button');
            if (btn) btn.style[property] = value;
        }

        function updateButtonText(text) {
            if (!selectedComponent) return;
            const btn = selectedComponent.querySelector('button');
            if (btn) btn.textContent = text;
        }

        function updateImage(url) {
            if (!selectedComponent) return;
            const img = selectedComponent.querySelector('img');
            if (img) img.src = url;
        }

        function moveUp(id) {
            const component = document.querySelector(`[data-component-id="${id}"]`);
            if (component && component.previousElementSibling) component.parentNode.insertBefore(component, component.previousElementSibling);
        }

        function moveDown(id) {
            const component = document.querySelector(`[data-component-id="${id}"]`);
            if (component && component.nextElementSibling) component.parentNode.insertBefore(component.nextElementSibling, component);
        }

        function deleteComponent(id) {
            const component = document.querySelector(`[data-component-id="${id}"]`);
            if (component && confirm('Delete this component?')) {
                component.remove();
                document.getElementById('propertiesPanel').innerHTML = '<div class="empty-state" style="padding-top: 100px;"><i class="bi bi-sliders"></i><p>Select a block to edit properties</p></div>';
            }
        }

        document.getElementById('triggerSelect')?.addEventListener('change', function() {
            document.getElementById('delayGroup').style.display = this.value === 'OnTimeDelay' ? 'block' : 'none';
        });

        document.getElementById('previewBtn').addEventListener('click', function() {
            document.getElementById('previewContent').innerHTML = document.getElementById('dropzone').innerHTML;
            new bootstrap.Modal(document.getElementById('previewModal')).show();
        });

        document.getElementById('saveBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
            const data = {
                id: popupId,
                content: JSON.stringify({ html: document.getElementById('dropzone').innerHTML }),
                targetingRules: JSON.stringify({ urls: (document.getElementById('urlTargeting')?.value || '').split('\n').filter(u => u.trim()), webhook: document.getElementById('webhookUrl')?.value || '' }),
                trigger: document.getElementById('triggerSelect')?.value || '@Model.Trigger',
                frequency: document.getElementById('frequencySelect')?.value || '@Model.Frequency',
                delayMs: parseInt(document.getElementById('delayInput')?.value || '0') * 1000,
                showOnMobile: document.getElementById('showMobile')?.checked ?? true,
                showOnDesktop: document.getElementById('showDesktop')?.checked ?? true
            };

            try {
                const response = await fetch(`/Popup/SaveDesign?id=${popupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    this.innerHTML = '<i class="bi bi-check2"></i> Saved!';
                    setTimeout(() => { this.innerHTML = '<i class="bi bi-check2"></i> Save'; this.disabled = false; }, 2000);
                } else {
                    alert('Error saving');
                    this.innerHTML = '<i class="bi bi-check2"></i> Save';
                    this.disabled = false;
                }
            } catch (error) {
                alert('Error: ' + error);
                this.innerHTML = '<i class="bi bi-check2"></i> Save';
                this.disabled = false;
            }
        });

        document.getElementById('blockSearch')?.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            document.querySelectorAll('.block-item').forEach(block => {
                block.style.display = block.querySelector('.block-name').textContent.toLowerCase().includes(query) ? 'flex' : 'none';
            });
        });
    </script>
</body>
</html>
